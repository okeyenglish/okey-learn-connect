

# Библиотека успешных диалогов для менеджеров

## Обзор

Создание библиотеки скриптов и примеров успешных диалогов для обучения менеджеров. Менеджеры смогут изучать реальные успешные кейсы, сгруппированные по сценариям, и использовать их как шаблоны для работы с клиентами.

## Архитектура

```text
+----------------------------+
| ConversationIndexingPanel  |
| (Tabs: Индексация,         |
|        Аналитика,          |
|        Поиск кейсов,       |
|        Скрипты)  <-- NEW   |
+----------------------------+
           |
           v
+----------------------------+
| SuccessfulDialoguesLibrary |  <-- NEW
| - Фильтры по сценарию      |
| - Карточки диалогов        |
| - Полный текст скрипта     |
| - Подсветка best practices |
+----------------------------+
           |
           v
+----------------------------+
| Edge Function:             |
| get-successful-dialogues   |  <-- NEW
+----------------------------+
           |
           v
+----------------------------+
| conversation_examples      |
| (quality >= 4, approved)   |
+----------------------------+
```

## Компоненты библиотеки

### 1. Фильтры (верхняя панель)
- Фильтр по сценарию (new_lead, scheduling, complaint и др.)
- Фильтр по исходу (converted, resolved, scheduled)
- Фильтр по качеству (4+, 5 только)
- Сортировка (по качеству, дате, популярности)

### 2. Галерея скриптов
- Карточки с превью диалога
- Сценарий + исход как бейджи
- Рейтинг качества (звездочки)
- Краткое описание ситуации

### 3. Детальный просмотр скрипта
- Полный текст диалога с разметкой ролей
- Подсветка ключевых фраз менеджера
- Контекст ситуации
- Чему можно научиться (выводы)

### 4. Интерактивные функции
- Кнопка "Скопировать фразу"
- Добавление в избранное
- Комментарии/заметки к скрипту

## Техническая реализация

### Edge Function: `get-successful-dialogues`

```typescript
interface DialogueExample {
  id: string;
  scenario_type: string;
  outcome: string;
  quality_score: number;
  context_summary: string;
  messages: Array<{
    role: 'manager' | 'client';
    content: string;
    timestamp: string;
  }>;
  key_phrases?: string[];
  created_at: string;
}

interface SuccessfulDialoguesResponse {
  dialogues: DialogueExample[];
  total: number;
  byScenario: Record<string, number>;
}
```

### Компонент: `SuccessfulDialoguesLibrary.tsx`

Основные разделы UI:
1. **Header**: Заголовок "Библиотека скриптов" с описанием
2. **Filters**: Горизонтальная панель фильтров
3. **Stats**: Счетчики по сценариям
4. **Gallery**: Grid с карточками диалогов
5. **Detail Modal/Sheet**: Полный скрипт с форматированием

### Интеграция

Добавление новой вкладки "Скрипты" в `ConversationIndexingPanel.tsx`:
- Tab 1: Индексация
- Tab 2: Аналитика  
- Tab 3: Поиск кейсов
- Tab 4: Скрипты (NEW)

## План реализации

### Шаг 1: Edge Function
Создать `supabase/functions/get-successful-dialogues/index.ts`:
- Выборка диалогов с quality_score >= 4
- Фильтрация по scenario_type и outcome
- Возврат полного messages JSON
- Агрегация количества по сценариям

### Шаг 2: Компонент библиотеки
Создать `src/components/admin/SuccessfulDialoguesLibrary.tsx`:
- Фильтры и панель управления
- Grid с карточками диалогов
- Sheet/Dialog для детального просмотра
- Форматированный вывод диалога

### Шаг 3: Компонент карточки
Создать `src/components/admin/DialogueScriptCard.tsx`:
- Превью диалога
- Бейджи сценария и исхода
- Рейтинг качества
- Клик для открытия детального просмотра

### Шаг 4: Компонент детального просмотра
Создать `src/components/admin/DialogueScriptDetail.tsx`:
- Полный текст диалога
- Визуальное разделение ролей (менеджер/клиент)
- Копирование отдельных фраз
- Контекстная информация

### Шаг 5: Интеграция
- Добавить вкладку в ConversationIndexingPanel
- Обновить config.toml для новой функции

## UI дизайн

### Карточка диалога
```text
+----------------------------------+
| [Новый лид]  [Конверсия]   ★★★★★ |
|----------------------------------|
| "Родитель интересовался курсами  |
| для ребенка 7 лет. Менеджер      |
| успешно записал на пробный урок" |
|----------------------------------|
| 12 сообщений | 15 янв 2026       |
+----------------------------------+
```

### Детальный просмотр
```text
+------------------------------------------+
| Скрипт: Запись нового клиента      [X]   |
|------------------------------------------|
| Сценарий: Новый лид | Исход: Конверсия   |
| Качество: ★★★★★ (5.0)                    |
|------------------------------------------|
| КОНТЕКСТ:                                |
| Родитель искал курсы английского для     |
| ребенка 7 лет перед школой               |
|------------------------------------------|
| ДИАЛОГ:                                  |
|------------------------------------------|
| Клиент  | Здравствуйте, хотела узнать    |
|         | про курсы для ребенка          |
|------------------------------------------|
| Менеджер| Добрый день! Сколько лет       |
| [Copy]  | ребенку и какой уровень?       |
|------------------------------------------|
| Клиент  | 7 лет, еще не учили            |
|------------------------------------------|
| Менеджер| Отлично! У нас есть группа     |
| [Copy]  | для начинающих 6-8 лет...      |
+------------------------------------------+
```

## Особенности

1. **Self-hosted**: Данные на api.academyos.ru, использовать `selfHostedGet`
2. **Колонка messages**: JSON с полным диалогом (роль + текст + время)
3. **Фильтр качества**: Показывать только approved=true И quality_score >= 4
4. **Копирование**: Быстрое копирование удачных фраз менеджера

