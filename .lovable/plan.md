

## План: Отображение всех групп для всех сотрудников

### Текущая проблема

В базе данных есть проблема с данными филиалов:

| branch | count |
|--------|-------|
| Окская | 11 |
| Окская, Новокосино, Котельники, Мытищи, Грайвороновская, ONLINE SCHOOL | 1 |

Второе значение - это ошибка. Один сотрудник имеет все филиалы записанные как одна строка через запятую вместо отдельных связей.

### Причина проблемы

Поле `profiles.branch` в схеме - это текстовое поле для ОДНОГО филиала. Когда вы добавили сотруднику все филиалы, они записались как одна строка "Окская, Новокосино, Котельники...".

### Решение

#### Шаг 1: Исправить данные в базе

Нужно выполнить SQL на self-hosted сервере, чтобы исправить некорректную запись:

```sql
-- Найти сотрудника с неправильным branch
SELECT id, first_name, last_name, branch 
FROM profiles 
WHERE branch LIKE '%,%';

-- Исправить на один филиал (например Окская)
UPDATE profiles 
SET branch = 'Окская'
WHERE branch LIKE '%,%';
```

#### Шаг 2: Удалить некорректную группу

```sql
-- Удалить группу с неправильным названием
DELETE FROM staff_group_chat_members 
WHERE group_chat_id IN (
  SELECT id FROM staff_group_chats 
  WHERE branch_name LIKE '%,%'
);

DELETE FROM staff_group_chats 
WHERE branch_name LIKE '%,%';
```

#### Шаг 3: Создать группы для всех филиалов из organization_branches

Обновить функцию `init-branch-groups` чтобы она создавала группы на основе таблицы `organization_branches`, а не `profiles.branch`:

```text
Текущая логика:
profiles.branch → staff_group_chats (неправильно!)

Новая логика:
organization_branches → staff_group_chats (правильно!)
```

#### Шаг 4: Добавить всех сотрудников во все группы

По вашему запросу, все сотрудники должны видеть все группы. Для этого нужно:

1. Получить все группы из `staff_group_chats`
2. Получить всех активных сотрудников из `profiles`
3. Добавить каждого сотрудника в каждую группу через `staff_group_chat_members`

### Технические изменения

**Файлы для изменения:**

1. `supabase/functions/init-branch-groups/index.ts` - обновить логику создания групп на основе `organization_branches`
2. `docs/selfhosted-functions/init-branch-groups.ts` - аналогичное обновление для self-hosted

**Новая логика функции:**

```text
init-branch-groups (v2):
┌─────────────────────────────────────────────────────────┐
│ 1. Получить филиалы из organization_branches            │
│    (вместо profiles.branch)                             │
├─────────────────────────────────────────────────────────┤
│ 2. Создать группу для каждого филиала                   │
│    "Команда {branch_name}"                              │
├─────────────────────────────────────────────────────────┤
│ 3. Получить ВСЕХ активных сотрудников из profiles       │
├─────────────────────────────────────────────────────────┤
│ 4. Добавить КАЖДОГО сотрудника в КАЖДУЮ группу          │
│    (без привязки к их филиалу)                          │
└─────────────────────────────────────────────────────────┘
```

### Порядок выполнения

1. Исправить данные в базе (SQL запросы выше)
2. Обновить функцию `init-branch-groups`
3. Задеплоить на self-hosted
4. Запустить `init-branch-groups` заново
5. Проверить отображение групп в AI Hub

### Результат

После выполнения все сотрудники будут видеть группы для каждого филиала:
- Команда Окская
- Команда Новокосино  
- Команда Котельники
- Команда Мытищи
- Команда Грайвороновская
- Команда ONLINE SCHOOL

И каждый сотрудник будет участником всех групп.

