

# Fix: Импортированные клиенты вытесняют реальные чаты из пагинации

## Проблема
Массовая привязка обновляет колонку `last_message_at` в таблице `clients` (через PATCH). Клиенты без реальных сообщений получают дату 01.01 и занимают слоты в пагинации, вытесняя реальные чаты с более старой активностью. Сортировка "Нет сообщений вниз" работает только в рамках уже загруженных данных, но проблема в том, что эти пустые клиенты загружаются ВМЕСТО реальных чатов.

## Решение

### 1. Файл: `src/components/admin/BulkBranchReassign.tsx`
**Причина**: PATCH-запрос обновляет `branch`, но PostgREST может автоматически обновлять `last_message_at` через триггер, или оно уже было установлено при создании клиента.

Добавить в PATCH-запрос явную установку `last_message_at: null` для клиентов, у которых нет реальных сообщений (чтобы они не занимали верхние позиции в пагинации):

```typescript
body: JSON.stringify({ 
  branch: targetBranch,
  last_message_at: null  // Сброс, чтобы не мешать пагинации
})
```

### 2. Файл: `src/hooks/useChatThreadsInfinite.ts`
**Строка 71**: Добавить фильтр `last_message_at` -- не загружать клиентов без реальной активности в основной поток чатов:

Изменить запрос клиентов:
```typescript
const { data: clients, error: clientsError } = await supabase
  .from('clients')
  .select('id, name, first_name, last_name, phone, branch, avatar_url, telegram_user_id, has_pending_payment')
  .not('last_message_at', 'is', null)
  .order('last_message_at', { ascending: false, nullsFirst: false })
  .range(offset, offset + limit - 1);
```

Это исключит клиентов без сообщений из пагинации, освободив слоты для реальных чатов.

### 3. Файл: `src/pages/CRM.tsx` (уже сделано)
Сортировка "Нет сообщений вниз" (строки 1325-1329) остается как дополнительная страховка для клиентов, попавших через поиск или закрепление.

## Порядок приоритетов
1. Основное исправление -- фильтр в `useChatThreadsInfinite` (п.2), чтобы пустые клиенты не загружались в список чатов
2. Превентивная мера -- обнуление `last_message_at` при привязке (п.1), чтобы будущие импорты не создавали проблему

