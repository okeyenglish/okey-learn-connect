
# –ü–ª–∞–Ω: –£–ª—É—á—à–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ Push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

## –û–±–∑–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–°–µ–π—á–∞—Å –≤ —Å–∏—Å—Ç–µ–º–µ –µ—Å—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ —Ç–∏–ø—ã push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:

| –¢–∏–ø | –§—É–Ω–∫—Ü–∏—è | –¢–µ–∫—É—â–∏–π —Ñ–æ—Ä–º–∞—Ç |
|-----|---------|----------------|
| –ß–∞—Ç WhatsApp ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º | `wappi-whatsapp-webhook` | `üí¨ –ò–º—è –∫–ª–∏–µ–Ω—Ç–∞` / `—Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è` |
| –ß–∞—Ç Telegram ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º | `telegram-webhook` | ‚ùå –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push |
| –ß–∞—Ç MAX ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º | `max-webhook` | ‚ùå –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç push |
| –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—á–∏—Ç–µ–ª—é | `lesson-reminders` | `‚è∞ –ó–∞–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ N –º–∏–Ω` / `–ì—Ä—É–ø–ø–∞ –≤ HH:MM` |
| –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—é | `parent-lesson-reminders` | –ß–µ—Ä–µ–∑ ChatOS/WhatsApp, –Ω–µ push |
| –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—Ä—Ç–∞–ª—É | `notify-portal-users` | `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –®–∫–æ–ª—ã` / `—Ç–µ–∫—Å—Ç` |

---

## –¶–µ–ª–µ–≤—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø–æ —Ç–∏–ø–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

### 1. –í—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤)
```text
Title: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
Body: –•–æ—Ä–æ—à–æ, —Å–ø–∞—Å–∏–±–æ!
Icon: üí¨ (WhatsApp) / ‚úàÔ∏è (Telegram) / üì® (MAX)
```

### 2. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± —É—Ä–æ–∫–µ (–¥–ª—è —É—á–∏—Ç–µ–ª–µ–π)
```text
Title: üéì –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –≤ O'KEY ENGLISH
Body: –ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ "Kids Box 2" —á–µ—Ä–µ–∑ 60 –º–∏–Ω
```

### 3. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± —É—Ä–æ–∫–µ (–¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π)
```text
Title: üìö –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –≤ O'KEY ENGLISH
Body: –ñ–¥—ë–º –í–∏–∫—Ç–æ—Ä–∞ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å
```

### 4. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö (–¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π –≤ –ø–æ—Ä—Ç–∞–ª–µ)
```text
Title: –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞ (–∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è)
Body: –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞...
```

### 5. –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫ (–µ—Å–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±—É–¥—É—â–µ–º)
```text
Title: üìû –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫
Body: +7 999 123-45-67 –∑–≤–æ–Ω–∏–ª –≤ 14:30
```

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª 1: `supabase/functions/wappi-whatsapp-webhook/index.ts`
**–°—Ç—Ä–æ–∫–∏ 355-366** ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç push –¥–ª—è –≤—Ö–æ–¥—è—â–∏—Ö WhatsApp:

```typescript
// –ë—ã–ª–æ:
payload: {
  title: `üí¨ ${client.name}`,
  body: messageText.slice(0, 100) + ...,
}

// –°—Ç–∞–Ω–µ—Ç:
const clientFullName = [client.first_name, client.last_name]
  .filter(Boolean).join(' ') || client.name || '–ö–ª–∏–µ–Ω—Ç';

payload: {
  title: clientFullName,
  body: messageText.slice(0, 100) + (messageText.length > 100 ? '...' : ''),
  icon: '/pwa-192x192.png',
  url: `/crm?clientId=${client.id}`,
  tag: `chat-${client.id}`,
}
```

### –§–∞–π–ª 2: `supabase/functions/telegram-webhook/index.ts`
**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~196** (–ø–æ—Å–ª–µ `console.log('Incoming message saved successfully')`) ‚Äî –¥–æ–±–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:

```typescript
// –î–æ–±–∞–≤–∏—Ç—å push –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –¥–ª—è Telegram
try {
  const { data: chatUsers } = await supabase
    .from('user_roles')
    .select('user_id')
    .in('role', ['admin', 'manager']);

  if (chatUsers && chatUsers.length > 0) {
    const userIds = chatUsers.map((u: { user_id: string }) => u.user_id);
    const clientFullName = client.first_name && client.last_name 
      ? `${client.first_name} ${client.last_name}`.trim()
      : client.name || senderName;
    
    await supabase.functions.invoke('send-push-notification', {
      body: {
        userIds,
        payload: {
          title: clientFullName,
          body: messageText.slice(0, 100) + (messageText.length > 100 ? '...' : ''),
          icon: '/pwa-192x192.png',
          url: `/crm?clientId=${client.id}`,
          tag: `chat-${client.id}`,
        },
      },
    });
  }
} catch (pushErr) {
  console.error('Error sending push notification:', pushErr);
}
```

### –§–∞–π–ª 3: `supabase/functions/max-webhook/index.ts`
**–ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ ~173** (–ø–æ—Å–ª–µ `console.log('Saved incoming MAX message')`) ‚Äî –¥–æ–±–∞–≤–∏—Ç—å push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:

```typescript
// –î–æ–±–∞–≤–∏—Ç—å push –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º –¥–ª—è MAX
try {
  const { data: chatUsers } = await supabase
    .from('user_roles')
    .select('user_id')
    .in('role', ['admin', 'manager']);

  if (chatUsers && chatUsers.length > 0) {
    const userIds = chatUsers.map((u: { user_id: string }) => u.user_id);
    const clientFullName = client.first_name && client.last_name 
      ? `${client.first_name} ${client.last_name}`.trim()
      : client.name || senderName;
    
    await supabase.functions.invoke('send-push-notification', {
      body: {
        userIds,
        payload: {
          title: clientFullName,
          body: messageText.slice(0, 100) + (messageText.length > 100 ? '...' : ''),
          icon: '/pwa-192x192.png',
          url: `/crm?clientId=${client.id}`,
          tag: `chat-${client.id}`,
        },
      },
    });
  }
} catch (pushErr) {
  console.error('Error sending push notification:', pushErr);
}
```

### –§–∞–π–ª 4: `supabase/functions/lesson-reminders/index.ts`
**–°—Ç—Ä–æ–∫–∏ 259-270** ‚Äî —É–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —É—á–∏—Ç–µ–ª—è–º:

```typescript
// –ë—ã–ª–æ:
payload: {
  title: `‚è∞ –ó–∞–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ ${Math.round(minutesUntilLesson)} –º–∏–Ω`,
  body: reminderText,
}

// –°—Ç–∞–Ω–µ—Ç:
// –ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
const { data: orgData } = await supabase
  .from('organizations')
  .select('name')
  .eq('id', lessonData?.organization_id)
  .single();

const orgName = orgData?.name || "O'KEY ENGLISH";
const groupName = lesson.learning_groups?.name || '–ì—Ä—É–ø–ø–∞';
const isGroup = groupName.toLowerCase().includes('–≥—Ä—É–ø–ø–∞') || 
                groupName.toLowerCase().includes('group');
const lessonType = isGroup ? '–ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ' : '–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ';

payload: {
  title: `üéì –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –≤ ${orgName}`,
  body: `${lessonType} "${groupName}" —á–µ—Ä–µ–∑ ${Math.round(minutesUntilLesson)} –º–∏–Ω`,
  icon: '/pwa-192x192.png',
  url: '/teacher-portal?tab=schedule',
  tag: `lesson-${lesson.id}-${Date.now()}`,
}
```

### –§–∞–π–ª 5: `supabase/functions/parent-lesson-reminders/index.ts`
**–°—Ç—Ä–æ–∫–∞ 232** ‚Äî —É–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Ä–æ–¥–∏—Ç–µ–ª—è–º:

```typescript
// –ë—ã–ª–æ:
const message = `üëã –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!\n\nüéì ${studentName} ‚Äî –∑–∞–Ω—è—Ç–∏–µ "${groupName}"\nüìÖ –°–µ–≥–æ–¥–Ω—è –≤ ${lesson.start_time}\n‚è∞ –î–æ –Ω–∞—á–∞–ª–∞ ~${Math.round(minutesUntilLesson)} –º–∏–Ω—É—Ç`;

// –°—Ç–∞–Ω–µ—Ç (–¥–ª—è WhatsApp/ChatOS):
const { data: orgData } = await supabase
  .from('organizations')
  .select('name')
  .eq('id', lesson.organization_id)
  .single();

const orgName = orgData?.name || "O'KEY ENGLISH";
const firstName = student.first_name || studentName.split(' ')[0];
const isIndividual = groupName.toLowerCase().includes('–∏–Ω–¥') || 
                     groupName.toLowerCase().includes('individual');
const lessonType = isIndividual ? '–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ' : '–≥—Ä—É–ø–ø–æ–≤–æ–µ';

const message = `üìö ${orgName}\n\n–ñ–¥—ë–º ${firstName} –Ω–∞ ${lessonType} –∑–∞–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ ${Math.round(minutesUntilLesson)} –º–∏–Ω.\n‚è∞ –ù–∞—á–∞–ª–æ –≤ ${lesson.start_time}`;
```

### –§–∞–π–ª 6: `supabase/functions/notify-portal-users/index.ts`
**–°—Ç—Ä–æ–∫–∏ 108-158** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:

```typescript
// –ë—ã–ª–æ (—Å—Ç—Ä–æ–∫–∏ 152-158):
const notificationTitle = unreadCount === 1
  ? `–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${schoolName}`
  : `${unreadCount} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π`;

const notificationBody = unreadCount === 1
  ? messagePreview
  : `–ü–æ—Å–ª–µ–¥–Ω–µ–µ: "${messagePreview}"`;

// –°—Ç–∞–Ω–µ—Ç:
// –ü–æ–ª—É—á–∏—Ç—å –∏–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
const { data: lastMsgData } = await supabase
  .from('chat_messages')
  .select('sender_name')
  .eq('client_id', notification.id)
  .eq('direction', 'outgoing')
  .eq('is_read', false)
  .order('created_at', { ascending: false })
  .limit(1)
  .single();

const senderName = lastMsgData?.sender_name || schoolName;

const notificationTitle = unreadCount === 1
  ? senderName
  : `${senderName} –∏ –µ—â—ë ${unreadCount - 1}`;

const notificationBody = messagePreview;
```

---

## –ò—Ç–æ–≥–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –ø–æ —Ç–∏–ø–∞–º

| –¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | Title | Body |
|-----------------|-------|------|
| WhatsApp ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä | –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è... |
| Telegram ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä | –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞ | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è... |
| MAX ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä | –°–µ—Ä–≥–µ–π –°–∏–¥–æ—Ä–æ–≤ | –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è... |
| –£—Ä–æ–∫ ‚Üí —É—á–∏—Ç–µ–ª—å | üéì –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –≤ O'KEY ENGLISH | –ì—Ä—É–ø–ø–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ "Kids Box 2" —á–µ—Ä–µ–∑ 60 –º–∏–Ω |
| –£—Ä–æ–∫ ‚Üí —Ä–æ–¥–∏—Ç–µ–ª—å | üìö O'KEY ENGLISH | –ñ–¥—ë–º –í–∏–∫—Ç–æ—Ä–∞ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ —á–µ—Ä–µ–∑ 1 —á–∞—Å |
| –ü–æ—Ä—Ç–∞–ª ‚Üí —Ä–æ–¥–∏—Ç–µ–ª—å | –ê–Ω–Ω–∞ –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–≤–∞ | –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞... |

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–î–æ–±–∞–≤–∏—Ç—å —ç–º–æ–¥–∑–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ –≤ —Ç–µ–≥** –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
   - `tag: 'whatsapp-chat-{clientId}'`
   - `tag: 'telegram-chat-{clientId}'`
   - `tag: 'max-chat-{clientId}'`

2. **–î–æ–±–∞–≤–∏—Ç—å –∞–≤–∞—Ç–∞—Ä –∫–ª–∏–µ–Ω—Ç–∞** –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω):
   ```typescript
   icon: client.avatar_url || '/pwa-192x192.png',
   ```

3. **–ó–≤—É–∫–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ** ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –∑–≤—É–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–ª–∏–µ–Ω—Ç–∞).
