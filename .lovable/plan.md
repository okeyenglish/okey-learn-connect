

## Проблема: Медленная загрузка чатов преподавателей

### Диагностика

Хук `useTeacherConversations` работает крайне неэффективно:

1. **Шаг 1**: Загружает ВСЕХ активных преподавателей из таблицы `teachers`
2. **Шаг 2**: Для каждой пачки из 30 преподавателей загружает до **1500 сообщений** (`30 * 50`) из `chat_messages`
3. **Шаг 3**: Вся обработка (группировка, подсчет непрочитанных, сортировка) происходит на клиенте

Если преподавателей 60, это **2 батча по 1500 = 3000 сообщений**, загружаемых в браузер только для того, чтобы показать последнее сообщение и счетчик непрочитанных.

### Решение

Заменить множественные тяжелые запросы на **один вызов RPC-функции** `get_teacher_chat_threads_fast` через REST API self-hosted сервера. Эта функция уже описана в `docs/sql-optimizations/create_teacher_chat_threads_mv.sql` и использует материализованное представление для мгновенной выдачи данных.

Если RPC недоступна (еще не применена миграция), используем **облегченный fallback**: вместо загрузки 50 сообщений на преподавателя, загружаем только **1 последнее сообщение** на преподавателя и отдельный запрос на подсчет непрочитанных.

### Технические детали

**Файл: `src/hooks/useTeacherConversations.ts`**

Полная переработка `queryFn`:

1. **Приоритет -- RPC**: Вызов `get_teacher_chat_threads_fast` через `SELF_HOSTED_URL/rest/v1/rpc/get_teacher_chat_threads_fast` с авторизацией. Возвращает готовые данные: имя клиента, последнее сообщение, счетчик непрочитанных -- все за один запрос к серверу.

2. **Fallback -- оптимизированные запросы**: Если RPC вернула ошибку (404/не существует):
   - Загрузка преподавателей (как сейчас)
   - Вместо загрузки 1500 сообщений на батч: один запрос с `limit(teacherIds.length)` и сортировкой `created_at DESC` для получения только последнего сообщения на преподавателя
   - Отдельный легкий запрос для подсчета непрочитанных: фильтр `is_read=false, is_outgoing=false` с `limit(1000)`

3. **Кэширование**: Увеличить `staleTime` до 60 секунд (вместо 30), так как данные из MV обновляются каждые 2 минуты.

Результат: вместо загрузки 3000+ строк сообщений -- один RPC-вызов, возвращающий ~20-60 строк готовых данных.

