
# ĞŸĞ»Ğ°Ğ½: ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ñ… Ğ² Ñ‡Ğ°Ñ‚Ğµ

## Ğ¦ĞµĞ»ÑŒ
Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°Ñ… Ğ² Ñ‡Ğ°Ñ‚Ğµ Ğ½Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ (ĞºĞ°Ğº "ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ñ‚Ñ‘Ğ¶" Ğ½Ğ° ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğµ) Ñ tooltip Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ Ğ¸ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ Ğ¾ĞºĞ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¸ ĞºĞ»Ğ¸ĞºĞµ.

## Ğ¢ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ
- Task notifications Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑÑÑ‚ÑÑ ĞºĞ°Ğº system messages Ñ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ¼: `Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° "ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ" ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ½Ğ° Ğ´Ğ°Ñ‚Ñƒ`
- ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ ĞºĞ°Ğº Ğ±Ğ¾Ğ»ÑŒÑˆĞ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ Ğ² Ñ‡Ğ°Ñ‚Ğµ
- ĞĞµÑ‚ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸ (Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ)

## Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ

### Ğ¨Ğ°Ğ³ 1: Ğ Ğ°ÑÑˆĞ¸Ñ€Ğ¸Ñ‚ÑŒ useSendMessage Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ metadata

**Ğ¤Ğ°Ğ¹Ğ»:** `src/hooks/useChatMessages.ts`

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºÑƒ Ğ¿Ğ¾Ğ»Ñ `metadata` Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:

```typescript
mutationFn: async ({
  clientId,
  messageText,
  messageType = 'manager',
  phoneNumberId,
  metadata // ĞĞ¾Ğ²Ğ¾Ğµ Ğ¿Ğ¾Ğ»Ğµ
}: {
  clientId: string;
  messageText: string;
  messageType?: 'client' | 'manager' | 'system';
  phoneNumberId?: string;
  metadata?: Record<string, unknown>; // ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿
}) => {
  const { data, error } = await supabase
    .from('chat_messages')
    .insert([{
      client_id: clientId,
      phone_number_id: phoneNumberId,
      message_text: messageText,
      message_type: messageType,
      is_read: messageType === 'manager',
      metadata, // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ metadata
    }])
    // ...
}
```

### Ğ¨Ğ°Ğ³ 2: ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ useTaskNotifications Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ task_id

**Ğ¤Ğ°Ğ¹Ğ»:** `src/hooks/useTaskNotifications.ts`

ĞœĞ¾Ğ´Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ¸ taskId, responsible Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² metadata:

```typescript
const sendTaskCreatedNotification = async (
  clientId: string, 
  taskTitle: string, 
  dueDate: string,
  taskId: string,
  responsible?: string
) => {
  await sendMessage.mutateAsync({
    clientId,
    messageText: `Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° "${taskTitle}" ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ½Ğ° ${dueDate}`,
    messageType: 'system',
    metadata: {
      type: 'task_notification',
      action: 'created',
      task_id: taskId,
      task_title: taskTitle,
      due_date: dueDate,
      responsible
    }
  });
};
```

### Ğ¨Ğ°Ğ³ 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ TaskNotificationMessage

**ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»:** `src/components/crm/TaskNotificationMessage.tsx`

ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² ÑÑ‚Ğ¸Ğ»Ğµ ÑĞºÑ€Ğ¸Ğ½ÑˆĞ¾Ñ‚Ğ°:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° â€¢ 12:09           â”‚  <- Ğ¿Ñ€Ğ¸ hover Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ tooltip
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:
- **Ğ˜ĞºĞ¾Ğ½ĞºĞ°**: Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ñ‚Ğ¸Ğ¿Ğ° (ğŸ“‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°, âœ… Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°, âŒ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°)
- **Ğ¢ĞµĞºÑÑ‚**: ĞšĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ñ‹Ğ¹ ("Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°", "Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°", "Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°")
- **Ğ’Ñ€ĞµĞ¼Ñ**: Ğ’Ñ€ĞµĞ¼Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- **Tooltip Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸**: 
  - ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
  - Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ (ĞºĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ°/ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°)
  - Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
- **ĞšĞ»Ğ¸Ğº**: ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ ViewTaskModal

### Ğ¨Ğ°Ğ³ 4: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ViewTaskModal

**ĞĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ»:** `src/components/crm/ViewTaskModal.tsx`

Read-only Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸:
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
- ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚
- Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ
- Ğ”Ğ°Ñ‚Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ
- Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
- ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" (Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ EditTaskModal)

### Ğ¨Ğ°Ğ³ 5: Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² ChatMessage.tsx

**Ğ¤Ğ°Ğ¹Ğ»:** `src/components/crm/ChatMessage.tsx`

Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ task notifications Ğ½Ğ° TaskNotificationMessage:

```typescript
// Detect task notification from metadata or message text
const isTaskNotification = useMemo(() => {
  if (metadata?.type === 'task_notification') return true;
  return message.includes('Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° "') && (
    message.includes('ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ½Ğ°') ||
    message.includes('ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°') ||
    message.includes('Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°')
  );
}, [metadata, message]);

if (type === 'system' && isTaskNotification) {
  return (
    <TaskNotificationMessage
      message={message}
      time={time}
      metadata={metadata}
    />
  );
}
```

### Ğ¨Ğ°Ğ³ 6: ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ useTaskNotifications

**Ğ¤Ğ°Ğ¹Ğ»Ñ‹:**
- `src/components/crm/AddTaskModal.tsx`
- `src/components/crm/ClientTasks.tsx`

ĞŸĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ taskId Ğ¸ responsible Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ notification Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹.

## Ğ˜Ğ·Ğ¼ĞµĞ½ÑĞµĞ¼Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

| Ğ¤Ğ°Ğ¹Ğ» | Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ |
|------|-----------|
| `src/hooks/useChatMessages.ts` | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ metadata Ğ² useSendMessage |
| `src/hooks/useTaskNotifications.ts` | Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ taskId Ğ¸ metadata Ğ² notification Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ |
| `src/components/crm/TaskNotificationMessage.tsx` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ (ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ñ tooltip) |
| `src/components/crm/ViewTaskModal.tsx` | Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ¼Ğ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ |
| `src/components/crm/ChatMessage.tsx` | Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ TaskNotificationMessage |
| `src/components/crm/AddTaskModal.tsx` | ĞŸĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ taskId Ğ² notification |
| `src/components/crm/ClientTasks.tsx` | ĞŸĞµÑ€ĞµĞ´Ğ°Ğ²Ğ°Ñ‚ÑŒ taskId Ğ² notification |

## Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚

**Ğ”Ğ¾:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [+] Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° "ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ" ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° â”‚
â”‚      Ğ½Ğ° 01.02.2026                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞŸĞ¾ÑĞ»Ğµ:**
```
      ğŸ“‹ Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ° â€¢ 12:09
        â†“ (Ğ¿Ñ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ĞŸĞ¾Ğ·Ğ²Ğ¾Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñƒ            â”‚
â”‚ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒ: Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ² Ğ˜.Ğ˜.     â”‚
â”‚ Ğ”Ğ°Ñ‚Ğ°: 01.02.2026             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Fallback Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹

Ğ”Ğ»Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ±ĞµĞ· metadata Ğ¿Ğ°Ñ€ÑĞ¸Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ· Ñ‚ĞµĞºÑÑ‚Ğ°:
- ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸: Ğ¼ĞµĞ¶Ğ´Ñƒ ĞºĞ°Ğ²Ñ‹Ñ‡ĞºĞ°Ğ¼Ğ¸ `"ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ"`
- Ğ¢Ğ¸Ğ¿ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ: Ğ¿Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğ¼ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼ (ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ°/Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°/Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°)
- Ğ—Ğ°Ğ´Ğ°Ñ‡Ñƒ Ğ¸ÑĞºĞ°Ñ‚ÑŒ Ğ¿Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ client_id
