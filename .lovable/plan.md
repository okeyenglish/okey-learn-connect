
# План: Добавление AI-резюме и записи звонков в карточки CRM

## Статус: ✅ Реализовано

## Текущее состояние

Система уже имеет всю необходимую backend-инфраструктуру:
- Edge function `analyze-call` — транскрипция + GPT-анализ звонка
- Edge function `fetch-call-recording` — получение записи из OnlinePBX  
- Edge function `generate-call-summary` — генерация простого резюме
- Компонент `CallEvaluationCard` — полное отображение AI-оценки
- Модальное окно `CallDetailModal` — детали с AI-анализом

**Проблема**: в карточке звонка (список) не отображается:
- AI-резюме или summary
- Мини-плеер для записи разговора
- Кнопка запуска анализа

## Задачи реализации

### 1. Компонент CallRecordingPlayer
**Файл**: `src/components/crm/CallRecordingPlayer.tsx`

Мини-аудиоплеер для записи звонка:
- Кнопка play/pause
- Прогресс-бар
- Длительность
- Кнопка скачивания
- Обработка ошибок загрузки

### 2. Обновление renderCallItem в CallHistory.tsx
**Файл**: `src/components/crm/CallHistory.tsx`

Добавить в карточку звонка:
- **Резюме** — если `call.summary` существует, показать его текстом под датой
- **Запись** — если `call.recording_url`, показать CallRecordingPlayer
- **AI-оценка badge** — если `call.ai_evaluation`, показать краткий score (уже есть)
- **Кнопка анализа** — если есть запись но нет AI-оценки, показать "Анализировать"

### 3. Интеграция с fetch-call-recording
При открытии карточки звонка проверять наличие записи:
- Если `recording_url` отсутствует, автоматически вызвать `fetch-call-recording`
- Показать индикатор загрузки
- Обновить данные после получения записи

### 4. Кнопка быстрого AI-анализа
Добавить в `CallSummaryPreview` или карточку:
- Кнопка "AI ✨" для запуска `analyze-call`
- Индикатор загрузки во время анализа
- Обновление после завершения

## Визуальное расположение

```text
┌─────────────────────────────────────────────────────────┐
│ 📞 Исходящий  [Состоялся]                    ⏱ 22с  👁 │
│ 📅 30 янв., 15:47                                      │
│ 79161168882                                            │
│                                                        │
│ 💬 "Клиент интересовался курсами для ребёнка..."       │ ← резюме
│                                                        │
│ 🎵 [▶ 0:00 ━━━━━━━━━━ 0:22]  ⬇️                        │ ← плеер
│                                                        │
│ [📝 Резюме] [🔹 Договорённости] [📋 3 задачи]          │ ← preview
│                                                        │
│ [✨ AI: 8.5/10]  или  [✨ Анализировать]               │ ← AI badge/button
└─────────────────────────────────────────────────────────┘
```

## Технические детали

### CallRecordingPlayer компонент
- Использовать нативный `<audio>` с кастомным UI
- Обработка ошибок для внешних URL (OnlinePBX)
- Lazy loading — не загружать audio пока не нажали play
- Размер: компактный, inline

### Оптимизации
- Мемоизация CallRecordingPlayer через React.memo
- useCallback для обработчиков в CallHistory
- Не блокировать рендер при fetch-call-recording

### Обработка ошибок
- Запись недоступна → показать badge "Запись не найдена"
- AI анализ failed → показать toast с ошибкой
- Rate limit (429) → показать сообщение "Попробуйте позже"

## Порядок реализации

1. Создать `CallRecordingPlayer.tsx`
2. Добавить отображение `summary` в `renderCallItem`
3. Интегрировать `CallRecordingPlayer` в карточку
4. Добавить кнопку "Анализировать" с вызовом `analyze-call`
5. Добавить автоматический `fetch-call-recording` при отсутствии записи
6. Тестирование на реальных звонках

## Зависимости

- Существующие hooks: `useCallHistory`, `useInfiniteCallHistory`
- Edge functions: `analyze-call`, `fetch-call-recording`, `get-call-logs`
- API: `selfHostedPost` для вызова функций
