
# План: Синхронизация статистики активности между устройствами

## Проблема
Статистика менеджера (время, звонки, сообщения, активность) хранится локально в `localStorage` каждого устройства. Desktop и PWA показывают разные данные, потому что каждое устройство ведёт независимый подсчёт.

## Решение
Добавить загрузку начального состояния из базы данных при инициализации трекера. Все устройства будут стартовать с одной базовой точки (агрегированные данные за сегодня из `staff_work_sessions`).

---

## Технические изменения

### 1. Создать хук для загрузки сессии из БД
**Файл:** `src/hooks/useTodayWorkSession.ts`

Новый хук будет:
- Запрашивать запись `staff_work_sessions` за сегодня для текущего пользователя
- Возвращать `active_seconds`, `idle_seconds`, `session_start`
- Кэшировать результат через React Query

### 2. Модифицировать useActivityTracker
**Файл:** `src/hooks/useActivityTracker.ts`

Изменения:
- Добавить параметр `serverBaseline` для начальных значений с сервера
- При инициализации:
  - Сначала загрузить локальное состояние
  - Сравнить с серверным baseline
  - Взять максимум из локального и серверного (чтобы не терять данные)
- Добавить синхронизацию при возврате на вкладку (`visibilitychange`)

### 3. Обновить UnifiedManagerWidget
**Файл:** `src/components/crm/UnifiedManagerWidget.tsx`

Изменения:
- Подключить `useTodayWorkSession` для получения серверного baseline
- Передать baseline в `useActivityTracker`
- Добавить индикатор синхронизации (опционально)

### 4. Добавить периодическую синхронизацию
**Файл:** `src/hooks/useActivityTracker.ts`

- При `visibilitychange === 'visible'` — перезапрашивать данные с сервера
- Объединять локальную дельту с серверным baseline

---

## Алгоритм синхронизации

```text
При старте приложения:
1. Загрузить локальное состояние из localStorage
2. Загрузить сессию за сегодня из staff_work_sessions
3. Если серверные данные новее или больше:
   - Использовать серверные как baseline
   - Сбросить локальную дельту
4. Если локальные данные больше:
   - Сохранить дельту на сервер
   - Продолжить с локальными

При переключении вкладки (из hidden в visible):
1. Перезапросить серверную сессию
2. Объединить: baseline = max(local, server)
```

---

## Миграции БД
Не требуются — таблица `staff_work_sessions` уже существует на self-hosted сервере.

---

## Файлы для изменения

| Файл | Действие |
|------|----------|
| `src/hooks/useTodayWorkSession.ts` | Создать (новый хук для загрузки сессии) |
| `src/hooks/useActivityTracker.ts` | Модифицировать (добавить синхронизацию) |
| `src/components/crm/UnifiedManagerWidget.tsx` | Модифицировать (подключить синхронизацию) |
| `src/components/crm/StaffActivityIndicator.tsx` | Модифицировать (подключить синхронизацию) |

---

## Ожидаемый результат
- Все устройства показывают одинаковую статистику
- При открытии на новом устройстве — данные подтягиваются с сервера
- Локальное отслеживание остаётся для отзывчивости UI
- Данные объединяются со всех устройств в единую сессию
