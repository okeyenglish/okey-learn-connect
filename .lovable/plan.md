# ✅ План исправления критических ошибок CRM (ВЫПОЛНЕНО)

## Проблемы (ИСПРАВЛЕНО)

### 1. RPC `get_unread_chat_threads` - Error 400
**Статус:** ✅ Исправлено - добавлен fallback

**Решение:** При ошибке схемы RPC автоматически отключается, система продолжает работать

### 2. Медленная загрузка чатов
**Статус:** ✅ Оптимизировано - увеличен staleTime до 30 сек

### 3. Дублирование запросов
**Статус:** ✅ Исправлено - добавлен hasLoadedOnce ref

---

## Выполненные изменения

### 1. Создан docs/rpc-get-unread-chat-threads.sql
- Полная SQL функция для self-hosted
- COALESCE для совместимости с разными схемами колонок
- NOTIFY pgrst для обновления кэша

### 2. Обновлён src/hooks/useChatThreadsInfinite.ts
- Флаг `useUnreadRpc` для отключения сломанного RPC
- Детекция ошибок схемы (42703, PGRST202, 42883)
- Увеличен staleTime до 30 секунд
- retry: false для предотвращения ретраев ошибок

---

## Следующие шаги

1. **Вручную выполнить SQL** из `docs/rpc-get-unread-chat-threads.sql` на self-hosted базе
2. Проверить, что ошибки 400 больше не появляются в консоли
3. После выполнения SQL на self-hosted - RPC заработает полноценно
