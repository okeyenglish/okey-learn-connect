

# Прокачка системы "Обучение AI на диалогах"

## Текущее состояние

Сейчас система состоит из 5 вкладок:

1. **Индексация** -- сканирует диалоги, анализирует через OpenAI (GPT-4o-mini), создает embeddings, сохраняет в `conversation_examples`
2. **Аналитика** -- статистика по сценариям, качеству, конверсиям
3. **Поиск кейсов** -- семантический поиск по проиндексированным диалогам
4. **Скрипты** -- библиотека успешных диалогов с фильтрами
5. **Тренажер** -- симулятор для менеджеров

### Как RAG используется сейчас

Есть ДВЕ точки использования проиндексированных диалогов:

- **`ask` (чат-бот для сайта)** -- ищет по таблице `docs` через `match_docs` RPC (это контент сайта, НЕ диалоги). Диалоги из `conversation_examples` здесь НЕ используются.
- **`generate-gpt-response` (подсказка менеджеру в CRM)** -- ИСПОЛЬЗУЕТ RAG: анализирует контекст через Gemini Flash Lite, создает embedding, ищет похожие примеры через `match_conversations` RPC, добавляет их в промпт как few-shot examples.

### Ключевые проблемы

1. **Чат-бот (`ask`) не учится на диалогах** -- использует только статический контент сайта, не знает реальных кейсов
2. **Нет автоматической индексации** -- нужно вручную запускать из админки
3. **Нет валидации качества** -- AI сам оценивает себя, нет human-in-the-loop
4. **Нет извлечения FAQ/паттернов** -- похожие вопросы не агрегируются
5. **Нет обратной связи** -- не отслеживается, помогли ли RAG-примеры
6. **Семантический поиск примитивный** -- `semantic-search-conversations` ищет по `ilike`, а не по embeddings

---

## План улучшений

### 1. Подключить RAG-диалоги к чат-боту (`ask`)

Сейчас `ask` использует только `match_docs` (контент сайта). Нужно добавить второй RAG-источник -- `match_conversations`, чтобы бот мог отвечать на вопросы типа "как записаться", "какие цены" используя реальные успешные диалоги.

**Что делаем:**
- В `supabase/functions/ask/index.ts` добавляем параллельный поиск по `conversation_examples` через embedding
- Найденные примеры добавляются в промпт как дополнительный контекст
- Приоритет: сначала данные сайта (`match_docs`), потом примеры из диалогов

### 2. Автоматическая индексация новых диалогов

Вместо ручного запуска -- автоматическая индексация завершенных диалогов.

**Что делаем:**
- Новая edge function `auto-index-conversation` -- вызывается когда диалог "остывает" (нет сообщений 24+ часа и >= 5 сообщений)
- Добавляем в `ConversationIndexingPanel` переключатель "Автоиндексация" с настройками
- Cron-задача (через существующий `process-events` или отдельно) проверяет завершенные диалоги раз в сутки

### 3. Извлечение FAQ из диалогов

Автоматическое выявление часто задаваемых вопросов из проиндексированных диалогов.

**Что делаем:**
- Новая вкладка "FAQ из диалогов" в панели обучения
- Edge function `extract-faq` -- кластеризует вопросы клиентов по темам, выделяет топ-вопросы и лучшие ответы
- Возможность утверждать FAQ и добавлять в базу знаний бота

### 4. Дашборд покрытия знаний (Knowledge Coverage)

Отображение того, на какие темы AI уже может ответить хорошо, а где есть пробелы.

**Что делаем:**
- Карта тем/сценариев с индикаторами покрытия (сколько примеров, средняя оценка)
- Визуализация "слепых зон" -- темы, по которым мало примеров или низкое качество
- Рекомендации: "Нужно больше примеров по теме X"

### 5. Обратная связь и Human-in-the-Loop

Менеджер может оценить: помог ли сгенерированный ответ.

**Что делаем:**
- В CRM при генерации ответа через `generate-gpt-response` добавляем кнопки "Использовал" / "Не подошло"
- Логирование в таблицу `ai_response_feedback`
- В дашборде аналитики -- метрики эффективности RAG

### 6. Улучшение семантического поиска

Текущий `semantic-search-conversations` использует `ilike` вместо vector search.

**Что делаем:**
- Переписываем на embedding-based поиск через тот же `match_conversations` RPC
- Добавляем фильтрацию по similarity threshold

---

## Техническая реализация

### Новые таблицы (миграция на self-hosted)
```text
ai_response_feedback
  - id, organization_id, user_id
  - conversation_example_id (FK)
  - client_id, response_text
  - feedback: 'used' | 'rejected' | 'edited'
  - created_at

extracted_faq
  - id, organization_id
  - question_cluster (текст обобщенного вопроса)
  - best_answer, source_example_ids[]
  - frequency (сколько раз встречался)
  - approved (boolean), created_at
```

### Изменения в edge functions
- `ask/index.ts` -- добавить RAG из `conversation_examples`
- `semantic-search-conversations/index.ts` -- переписать на vector search
- Новые: `auto-index-conversation`, `extract-faq`

### Изменения в UI
- `ConversationIndexingPanel.tsx` -- добавить вкладки "FAQ", "Покрытие", toggle автоиндексации
- Компонент обратной связи в CRM чате
- Дашборд покрытия знаний

### Порядок реализации
1. Подключить RAG-диалоги к `ask` (самый большой эффект)
2. Исправить семантический поиск на vector-based
3. Добавить обратную связь
4. Автоматическая индексация
5. Извлечение FAQ
6. Дашборд покрытия

