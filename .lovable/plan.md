
## Что реально происходит (переформулировка проблемы)

При клике на диалог в AI Hub на десктопе приложение падает в “белый экран”. Это выглядит как “обновление страницы”, но по факту чаще всего это аварийный сброс React из‑за ошибки рендера.

У нас уже есть симптом из runtime ошибок: **“Rendered fewer hooks than expected”** — это классическая ошибка, когда внутри одного компонента хуки вызываются не всегда.

## Изоляция места, где ломается

Файл: `src/components/ai-hub/AIHub.tsx`

Критическая конструкция в текущем коде:
- Внутри компонента `AIHub` есть **ранние `return`**:
  - `if (activeChat?.type === 'assistant') return (...)` (примерно строки 545+)
  - `if (activeChat) return (...)` (примерно строки 584+)
- Но ниже по файлу объявлены хуки:
  - `const [selectedBranch, setSelectedBranch] = useState('all');`
  - `const [staffFilter, setStaffFilter] = useState('all');`
  (примерно строки 763–764)

Когда `activeChat` становится не `null` (после клика на диалог), компонент начинает возвращаться раньше и **перестаёт вызывать эти `useState`** → React видит “меньше хуков, чем ожидалось” → падает рендер.

### Do I know what the issue is?
Да. Это нарушение “Rules of Hooks”: хуки объявлены после ветвления с `return`.

## Решение (что будем менять)

### 1) Исправить нарушение хуков в `AIHub.tsx`
Сделать так, чтобы **все хуки вызывались всегда** в одном и том же порядке.

Самый короткий и безопасный фикс:
- Перенести `useState` для `selectedBranch` и `staffFilter` вверх, рядом с остальными `useState` (до любых `return`).
- Удалить/переместить текущие объявления (строки ~763-764), чтобы не было дублей.

Это устранит “Rendered fewer hooks than expected” и снимет основной краш при выборе чата.

### 2) (Рекомендуемый харднинг) Убрать ранние `return` через лёгкий рефакторинг
Чтобы такие ошибки не возвращались при будущих правках:

- Вынести разные режимы UI в отдельные компоненты:
  - `AIHubChatView` (экран переписки)
  - `AIHubListView` (список чатов)
- В `AIHub` оставить только верхнеуровневые хуки/данные + переключение, что показывать.

Плюсы: проще поддерживать, меньше риск “сломать хуки” снова.

### 3) Диагностика “ощущения перезагрузки”
После фикса хуков:
- Проверим, что при клике на чат не происходит реального перехода на `/` (вкладка Network → Document запросы).
- Если всё же есть реальная перезагрузка, добавим защиту: явные `type="button"` для всех “сырых” `<button>` внутри списка (не shadcn `<Button />`), чтобы исключить случайный submit (редко, но бывает при нетипичных обёртках/порталах).

## Порядок работ

1. Открыть `src/components/ai-hub/AIHub.tsx`
2. Переместить:
   - `const [selectedBranch, setSelectedBranch] = useState<string>('all');`
   - `const [staffFilter, setStaffFilter] = useState<'all' | 'online'>('all');`
   вверх, к остальным `useState` (примерно после `teacherClientId` и прочих state).
3. Удалить старые объявления этих хуков внизу (строки ~763-764).
4. (Опционально, но желательно) Внести минимальный рефакторинг: вынести `activeChat`-ветки в дочерние компоненты, чтобы в основном компоненте не было ранних `return` до хуков.
5. Протестировать на десктопе:
   - открыть AI Hub
   - кликнуть по сотруднику
   - кликнуть по AI помощнику/консультанту
   - убедиться, что белого экрана нет, чат открывается стабильно

## Файлы, которые будут изменены

- `src/components/ai-hub/AIHub.tsx`
  - перенос `useState` (обязательный)
  - возможный рефакторинг на 2 подкомпонента (рекомендуемый)

## Критерии готовности

- На десктопе клик по любому диалогу **не приводит** к белому экрану.
- Ошибка “Rendered fewer hooks than expected” больше не появляется.
- На мобильной версии поведение не ломается (регрессия отсутствует).
