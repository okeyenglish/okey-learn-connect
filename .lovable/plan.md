
Цель: понять почему “группы созданы, но никому не отображаются” и исправить фильтр/запрос так, чтобы список групп стабильно появлялся в ChatOS.

## Что сейчас реально запрашивает фронтенд и где “не проходит фильтр”

### 1) Фронтенд (src/hooks/useStaffGroupChats.ts)
Хук `useStaffGroupChats()` делает запрос на self-hosted backend-функцию:

- endpoint: `POST https://api.academyos.ru/functions/v1/get-staff-group-chats`
- body сейчас всегда такой:
```ts
{
  organization_id: '00000000-0000-0000-0000-000000000001', // HARD-CODED
  user_id: user.id
}
```

То есть организация на фронте зафиксирована константой `DEFAULT_ORGANIZATION_ID`, а **не берётся из профиля**.

### 2) Бэкенд-функция (supabase/functions/get-staff-group-chats/index.ts)
Внутри функция делает именно такой фильтр:
```ts
.from('staff_group_chats')
.select('*')
.eq('organization_id', organization_id)
```

Следовательно: если группы в self-hosted базе созданы с `organization_id != 0000...0001`, то функция честно вернёт 0 строк, и UI покажет пусто для всех.

### 3) Почему группы могли создаваться “правильно”, но не отображаться
Создание/привязка групп в других местах (например, `add-employee-to-branch-groups` и `create-staff-group-chat`) использует **реальный** `organization_id` (из приглашения/профиля).  
А список групп запрашивается по **другому** org id (хардкод). Это типичный “разъехавшийся tenant-id”.

Итог: фильтр, из‑за которого “всё не проходит” — это `.eq('organization_id', ...)` на стороне функции + неверный `organization_id` в body на стороне фронта.

---

## План исправления (минимальный и безопасный)

### Шаг 1. Починить источник organization_id в `useStaffGroupChats`
Файл: `src/hooks/useStaffGroupChats.ts`

Изменения:
1) Забрать `profile` из `useAuth()` (сейчас берётся только `user`).
2) Вычислять org id так:
- основной: `profile?.organization_id`
- fallback: текущий `DEFAULT_ORGANIZATION_ID` (чтобы не сломать случаи, когда профиль реально пустой/не прогрузился)
3) Передавать вычисленный `organization_id` в `selfHostedPost('get-staff-group-chats', ...)`
4) Обновить `queryKey`, чтобы кэш React Query различал организации:
   - было: `['staff-group-chats', user?.id]`
   - станет: `['staff-group-chats', organizationId, user?.id]`
5) Логи в консоль сделать более диагностичными: логировать `organizationIdFromProfile`, `effectiveOrganizationId`, `response.status`.

Ожидаемый эффект: список групп начнёт возвращать данные из правильного tenant-а, и UI сразу начнёт их показывать (UI дополнительных фильтров по членству не делает).

### Шаг 2. Привести `useCreateStaffGroupChat` к той же логике org id (консистентность)
Файл: `src/hooks/useStaffGroupChats.ts` (внутри `useCreateStaffGroupChat`)

Сейчас создание группы делает строгую проверку:
- если нет `profile?.organization_id` → ошибка “Требуется авторизация”.

План:
- использовать тот же `effectiveOrganizationId = profile?.organization_id ?? DEFAULT_ORGANIZATION_ID`
- оставлять проверку на `user?.id` (пользователь обязан быть залогинен), а отсутствие org id не должно блокировать создание (иначе можно создать “пустую” ситуацию, когда группы создаются одним путём, а читать нельзя другим).

Это не “обязательный” шаг для отображения, но он убирает будущие расхождения.

### Шаг 3. Сделать ошибку запроса видимой (чтобы не было “тихо пусто”)
Сейчас при `response.success === false` хук просто возвращает `[]`, и пользователь визуально не понимает: “нет групп” или “запрос упал”.

План:
- если `response.success === false`:
  - выводить `toast.error` с коротким текстом (например: “Не удалось загрузить группы: HTTP 401/403/500”)
  - оставить возврат `[]`, чтобы UI не падал

Это поможет отличить “неправильный org_id” от “не задеплоилось / verify_jwt / CORS”.

---

## Проверка после фикса (что именно проверяем)
1) Открыть ChatOS (AI Hub) под любым сотрудником.
2) В DevTools → Network найти запрос `get-staff-group-chats` и проверить:
   - body содержит `organization_id` равный `profile.organization_id` этого сотрудника (а не 0000…0001)
   - ответ `200` и JSON вида `{ "groups": [...] }`
3) В UI убедиться:
   - группы появились в списке даже при фильтре “online” (в коде группы всегда показываются)
4) Проверить крайний случай:
   - если профиль не загрузился/пустой — запрос уйдёт с DEFAULT_ORGANIZATION_ID и не сломает старый сценарий.

---

## Если после Шага 1 всё равно пусто (быстрая диагностика)
Тогда причина не в фильтре org, а в том что функция на self-hosted:
- не задеплоена / не обновилась,
- или возвращает 401/403 (verify_jwt),
- или отдаёт не-JSON (ошибка шлюза).

Что делаем:
- по новому `toast`/логам смотрим `response.status` и `response.error`,
- смотрим фактический response body (в Network),
- и уже точечно: правим self-hosted деплой/verify_jwt.

---

## Файлы, которые будут затронуты
- `src/hooks/useStaffGroupChats.ts` (ключевой фикс источника organization_id + улучшение диагностики)
