
# –°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

## ‚úÖ –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤—ã–π —Ç—Ä–µ–∫–∏–Ω–≥ (–ó–ê–í–ï–†–®–ï–ù–ê)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **useActivityTracker** (`src/hooks/useActivityTracker.ts`) ‚úÖ
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π: mousemove, keydown, click, scroll, touchstart
   - Throttled –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (30 —Å–µ–∫)
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ idle –ø–æ—Å–ª–µ 5 –º–∏–Ω—É—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   - –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ localStorage
   - –°—Ç–∞—Ç—É—Å—ã: online, idle, on_call, offline

2. **useWorkSession** (`src/hooks/useWorkSession.ts`) ‚úÖ
   - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–π —Å–µ—Å—Å–∏–µ–π
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞/–∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
   - –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ

3. **useStaffOnlinePresence** (–æ–±–Ω–æ–≤–ª—ë–Ω) ‚úÖ
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π payload: status, sessionStart, activeTime, idleTime, activityPercentage
   - –ù–æ–≤—ã–π –º–µ—Ç–æ–¥ getUserStatus()
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ª–µ–π –ø—Ä–∏ sync

4. **StaffActivityIndicator** (`src/components/crm/StaffActivityIndicator.tsx`) ‚úÖ
   - –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –≤ —Ö–µ–¥–µ—Ä–µ
   - –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è: –∑–µ–ª–µ–Ω—ã–π (–æ–Ω–ª–∞–π–Ω), –∂–µ–ª—Ç—ã–π (–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω), —Å–∏–Ω–∏–π (–Ω–∞ –∑–≤–æ–Ω–∫–µ)
   - –¢–∞–π–º–µ—Ä —Å–µ—Å—Å–∏–∏
   - –ü—Ä–æ—Ü–µ–Ω—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π
   - Tooltip —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   - –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö

5. **StaffActivityDashboard** (`src/components/crm/StaffActivityDashboard.tsx`) ‚úÖ
   - Dashboard –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π
   - –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –∏—Ö —Å—Ç–∞—Ç—É—Å–∞–º–∏
   - –ê–ª–µ—Ä—Ç—ã –æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (>10 –º–∏–Ω)
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: on_call ‚Üí online ‚Üí idle ‚Üí offline

---

## ‚úÖ –§–∞–∑–∞ 2: –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ó–ê–í–ï–†–®–ï–ù–ê)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **SQL –º–∏–≥—Ä–∞—Ü–∏—è** (`docs/migrations/add_staff_work_tracking.sql`) ‚úÖ
   - –¢–∞–±–ª–∏—Ü–∞ `staff_work_sessions` –¥–ª—è —Ä–∞–±–æ—á–∏—Ö —Å–µ—Å—Å–∏–π
   - –¢–∞–±–ª–∏—Ü–∞ `staff_daily_stats` –¥–ª—è –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
   - RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
   - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

2. **Edge Function** (`save-work-session`) ‚úÖ
   - Upsert —Å–µ—Å—Å–∏–∏ –ø–æ user_id + session_date
   - –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ active/idle/on_call —Å–µ–∫—É–Ω–¥
   - Tracking idle events –∏ max idle streak

3. **useSessionPersistence** (`src/hooks/useSessionPersistence.ts`) ‚úÖ
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/—Å–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (sendBeacon)
   - –†–∞—Å—á—ë—Ç –¥–µ–ª—å—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω –≤ StaffActivityIndicator

### –¢—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å SQL –Ω–∞ self-hosted:
```sql
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –∏–∑ docs/migrations/add_staff_work_tracking.sql
```

---

## ‚úÖ –§–∞–∑–∞ 3: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (–ó–ê–í–ï–†–®–ï–ù–ê)

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **Edge Function** (`aggregate-staff-stats`) ‚úÖ
   - –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞ –¥–µ–Ω—å –∏–∑ staff_work_sessions –≤ staff_daily_stats
   - –†–∞—Å—á—ë—Ç efficiency_score (productive/total time)
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏ cron

2. **StaffAnalyticsPanel** (`src/components/crm/StaffAnalyticsPanel.tsx`) ‚úÖ
   - Summary –∫–∞—Ä—Ç–æ—á–∫–∏: –æ–Ω–ª–∞–π–Ω, —Å—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å, –æ–±—â–µ–µ –≤—Ä–µ–º—è, –Ω–∞ –∑–≤–æ–Ω–∫–∞—Ö
   - –ê–ª–µ—Ä—Ç—ã –æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (>10 –º–∏–Ω)
   - –°–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
   - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å—É –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron (self-hosted):
```sql
SELECT cron.schedule(
  'aggregate-staff-stats-hourly',
  '0 * * * *', -- –∫–∞–∂–¥—ã–π —á–∞—Å
  $$
  SELECT net.http_post(
    url := 'https://api.academyos.ru/functions/v1/aggregate-staff-stats',
    headers := '{"Content-Type": "application/json", "Authorization": "Bearer –í–°–¢–ê–í–¨–¢–ï_ANON_KEY"}'::jsonb,
    body := '{}'::jsonb
  ) AS request_id;
  $$
);
```

---

## üî≤ –§–∞–∑–∞ 4: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å KPI (–ü–õ–ê–ù–ò–†–£–ï–¢–°–Ø)

- –°–≤—è–∑—å —Å manager_kpi_settings
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- –û—Ç—á—ë—Ç—ã –≤ Telegram
- –ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è (–±–µ–π–¥–∂–∏, —É—Ä–æ–≤–Ω–∏)

---

## –°—Ç–∞—Ç—É—Å—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

| –°—Ç–∞—Ç—É—Å | –£—Å–ª–æ–≤–∏–µ | –¶–≤–µ—Ç | –ò–∫–æ–Ω–∫–∞ |
|--------|---------|------|--------|
| –û–Ω–ª–∞–π–Ω | –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å < 5 –º–∏–Ω | üü¢ | Circle (filled) |
| –ù–∞ –∑–≤–æ–Ω–∫–µ | –ê–∫—Ç–∏–≤–Ω—ã–π –∑–≤–æ–Ω–æ–∫ | üîµ | Phone |
| –ù–µ–∞–∫—Ç–∏–≤–µ–Ω | –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å 5+ –º–∏–Ω | üü° | Clock |
| –û—Ñ—Ñ–ª–∞–π–Ω | –ù–µ—Ç heartbeat 2+ –º–∏–Ω | ‚ö™ | Circle (outline) |

---

## –ö–ª—é—á–µ–≤—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã

1. **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞**: –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Presence –∫–∞–Ω–∞–ª
2. **Privacy**: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –≤–∏–¥–∏—Ç —Å–≤–æ–π —Å—Ç–∞—Ç—É—Å, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å - –∫–æ–º–∞–Ω–¥—ã
3. **–ß–µ—Å—Ç–Ω–æ—Å—Ç—å**: —Ç–æ—á–Ω—ã–π —É—á—ë—Ç –±–µ–∑ –º–∏–∫—Ä–æ–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞
4. **–ú–æ—Ç–∏–≤–∞—Ü–∏—è**: —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫–∞—Ö
