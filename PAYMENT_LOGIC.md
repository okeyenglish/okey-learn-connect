# Логика оплат и расчетов

## Единая система измерений

### Академический час (а.ч.)
- **1 академический час = 40 минут**
- Это базовая единица измерения для всех оплат

### Таблица payments
**КРИТИЧЕСКИ ВАЖНО:** 
- Поле `lessons_count` в таблице `payments` **ВСЕГДА** хранит количество **академических часов** (не занятий!)
- При создании платежа указывается количество академических часов
- Пример: Оплата за 8 занятий по 80 минут = 16 академических часов

### Групповые занятия
- Стандартная длительность: **80 минут** = **2 академических часа**
- Некоторые курсы: **60 минут** = **1.5 академических часа**
- Длительность берется из таблицы `group_course_prices.duration_minutes`

#### Конвертация для групповых занятий:
```
academicHoursPerLesson = duration_minutes / 40

Примеры:
- 80 минут / 40 = 2 а.ч. на занятие
- 60 минут / 40 = 1.5 а.ч. на занятие

Количество оплаченных занятий = totalPaidAcademicHours / academicHoursPerLesson
```

### Индивидуальные занятия
- Длительность может варьироваться
- Оплата также ведется в академических часах
- При создании индивидуального занятия длительность конвертируется в академические часы

## Расчет остатка и задолженности

### Остаток (Remaining)
```
Оплачено: totalPaidMinutes = totalPaidAcademicHours × 40
Использовано: usedMinutes = usedSessionsCount × lessonDuration
Остаток минут: remainingMinutes = totalPaidMinutes - usedMinutes
Остаток денег: remainingAmount = (totalPaidAmount / totalPaidMinutes) × remainingMinutes
```

### Задолженность (Debt)
```
Если usedMinutes > totalPaidMinutes:
  debtMinutes = usedMinutes - totalPaidMinutes
  debtAmount = debtMinutes × pricePerMinute (из прайс-листа курса)
```

### Неоплаченное (Unpaid)
```
Общее количество занятий: totalCourseLessons (после даты зачисления)
Общее количество минут: totalCourseMinutes = totalCourseLessons × lessonDuration
Неоплаченные минуты: unpaidMinutes = totalCourseMinutes - totalPaidMinutes
```

## Важные правила

1. **Дата зачисления (enrollment_date)**
   - Все расчеты ведутся только для занятий ПОСЛЕ даты зачисления
   - Занятия ДО зачисления не учитываются в расчетах

2. **Отмененные занятия**
   - Занятия с флагом `is_cancelled_for_student` не учитываются
   - Занятия со статусом `cancelled` (для всей группы) не учитываются

3. **Использованные занятия**
   - Занятие считается использованным если:
     - Статус = `completed` ИЛИ
     - Дата занятия < сегодня И статус != `cancelled`

4. **Синхронизация данных**
   - Страница ученика показывает те же данные, что и страница группы
   - Расписание фильтруется по дате зачисления одинаково везде
   - Оплаченные занятия распределяются в хронологическом порядке после зачисления

## Примеры расчетов

### Пример 1: Групповое занятие (80 мин)
```
Оплачено: 24 академических часа
Длительность занятия: 80 минут = 2 а.ч.
Количество оплаченных занятий: 24 / 2 = 12 занятий

Проведено: 1 занятие (80 минут = 2 а.ч.)
Остаток: 24 - 2 = 22 а.ч. = 11 занятий

Если сумма оплаты = 19980₽:
Остаток денег = (19980 / 960 минут) × 880 минут = 18315₽
```

### Пример 2: Задолженность
```
Оплачено: 8 академических часов = 4 занятия по 80 мин
Проведено: 5 занятий = 10 академических часов

Использовано минут: 5 × 80 = 400 минут
Оплачено минут: 8 × 40 = 320 минут

Задолженность: 400 - 320 = 80 минут = 2 а.ч.
Сумма задолженности: 80 × pricePerMinute (из прайс-листа)
```

## Файлы с логикой

1. **useStudentGroupPaymentStats.ts** - расчет статистики оплат для группового курса
2. **useStudentDetails.ts** - получение данных о студенте и его занятиях
3. **GroupScheduleCalendar.tsx** - отображение расписания группы
4. **StudentPaymentInfo.tsx** - компонент отображения оплат и остатков
