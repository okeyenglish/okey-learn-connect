# –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç –∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç –≤ CRM —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∑–∞–∏–º–æ—Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

1. **–ü–ª–∞—Ç–µ–∂–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤** (`payments`) - –≤—Ö–æ–¥—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏ –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
2. **–ë–∞–ª–∞–Ω—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤** (`student_balances`, `balance_transactions`) - —É—á–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –∏ –µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π
3. **–ù–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º** (`teacher_earnings`) - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –∑–∞—Ä–ø–ª–∞—Ç—ã
4. **–°—Ç–∞–≤–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π** (`teacher_rates`) - —Ç–∞—Ä–∏—Ñ—ã –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞
5. **–í—ã–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º** (`teacher_payments`) - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–ø–ª–∞—Ç—ã

---

## 1. –ü–ª–∞—Ç–µ–∂–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

### –¢–∞–±–ª–∏—Ü–∞: `payments`

–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–∞—Ö –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –∑–∞ –æ–±—É—á–µ–Ω–∏–µ.

**–ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:**
- `student_id` - UUID —Å—Ç—É–¥–µ–Ω—Ç–∞
- `amount` - —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ä—É–±–ª—è—Ö
- `lessons_count` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–æ–≤ (1 –∞.—á. = 40 –º–∏–Ω)
- `payment_date` - –¥–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞
- `method` - —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã (cash, card, transfer)
- `status` - —Å—Ç–∞—Ç—É—Å (pending, completed, cancelled)
- `individual_lesson_id` / `group_id` - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–∏–ø—É –∑–∞–Ω—è—Ç–∏–π

### –õ–æ–≥–∏–∫–∞ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞** (`usePayments.createPayment()`):

1. –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `payments`
2. –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∞.—á. –≤ –º–∏–Ω—É—Ç—ã: `remainingMinutes = lessons_count √ó 40`
3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ 2 —ç—Ç–∞–ø–∞:
   - **–®–∞–≥ 1**: –ó–∞–ø–æ–ª–Ω—è–µ—Ç —á–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è (–≥–¥–µ `paid_minutes > 0` –Ω–æ –º–µ–Ω—å—à–µ `duration`)
   - **–®–∞–≥ 2**: –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–Ω—É—Ç—ã –ø–æ —Å–∞–º—ã–º —Ä–∞–Ω–Ω–∏–º –¥–∞—Ç–∞–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
4. –î–ª—è –∫–∞–∂–¥–æ–π —Å–µ—Å—Å–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:
   - `paid_minutes` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –º–∏–Ω—É—Ç
   - `payment_id` - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –ø–ª–∞—Ç–µ–∂—É
5. –ï—Å–ª–∏ —Å–µ—Å—Å–∏–∏ –Ω–µ—Ç –Ω–∞ –¥–∞—Ç—É - —Å–æ–∑–¥–∞–µ—Ç—Å—è –Ω–æ–≤–∞—è —Å `status='scheduled'`

**–£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞** (`usePayments.deletePayment()`):

1. –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Å–µ—Å—Å–∏–∏ —Å `payment_id` —É–¥–∞–ª—è–µ–º–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
2. –û–±–Ω—É–ª—è–µ—Ç `paid_minutes` –∏ `payment_id` —É —ç—Ç–∏—Ö —Å–µ—Å—Å–∏–π
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç** –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–ª–∞—Ç–µ–∂–∏ –ø–æ —Å–∞–º—ã–º —Ä–∞–Ω–Ω–∏–º –¥–∞—Ç–∞–º

**–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (`useIndividualLessonPaymentStats`):

```typescript
paidMinutes = —Å—É–º–º–∞ –≤—Å–µ—Ö (lessons_count √ó 40) –∏–∑ payments
usedMinutes = —Å—É–º–º–∞ duration –ø—Ä–æ—à–µ–¥—à–∏—Ö/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π
              (–∏—Å–∫–ª—é—á–∞—è cancelled/free/rescheduled)
remainingMinutes = paidMinutes - usedMinutes
debtMinutes = –µ—Å–ª–∏ usedMinutes > paidMinutes
pricePerMinute = –±–∞–∑–∏—Ä—É–µ—Ç—Å—è –Ω–∞ price_per_40_min –∏–∑ course_prices
```

### –õ–æ–≥–∏–∫–∞ –¥–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π

**–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**

1. –ü–ª–∞—Ç–µ–∂ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å `group_id` –∏ `lessons_count` (–≤ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–∞—Ö)
2. –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - —Ç–æ–ª—å–∫–æ —É—á–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–†–∞—Å—á–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** (`useStudentGroupPaymentStats`):

```typescript
totalPaidMinutes = —Å—É–º–º–∞ (lessons_count √ó 40) –¥–ª—è –≤—Å–µ—Ö payments —Å—Ç—É–¥–µ–Ω—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
usedMinutes = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—à–µ–¥—à–∏—Ö/–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π –∏–∑ student_lesson_sessions
remainingMinutes = totalPaidMinutes - usedMinutes
```

**–í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:**
- –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `enrollment_date` —Å—Ç—É–¥–µ–Ω—Ç–∞ (—Ç–æ–ª—å–∫–æ –∑–∞–Ω—è—Ç–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–π –¥–∞—Ç—ã)
- –ò—Å–∫–ª—é—á–∞—é—Ç—Å—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è (`is_cancelled_for_student`, `is_cancelled`)
- –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ/–±–æ–Ω—É—Å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è (`is_free`, `is_bonus`)

---

## 2. –ë–∞–ª–∞–Ω—Å —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

### –¢–∞–±–ª–∏—Ü–∞: `student_balances`

–•—Ä–∞–Ω–∏—Ç —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –∫–∞–∂–¥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞.

**–ü–æ–ª—è:**
- `student_id` - UUID —Å—Ç—É–¥–µ–Ω—Ç–∞ (PK)
- `balance` - —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –≤ —Ä—É–±–ª—è—Ö (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º = –¥–æ–ª–≥)
- `academic_hours` - –±–∞–ª–∞–Ω—Å –≤ –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–∞—Ö

### –¢–∞–±–ª–∏—Ü–∞: `balance_transactions`

–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞.

**–ü–æ–ª—è:**
- `student_id` - UUID —Å—Ç—É–¥–µ–Ω—Ç–∞
- `amount` - —Å—É–º–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è (–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è = –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è = —Å–ø–∏—Å–∞–Ω–∏–µ)
- `academic_hours` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –∞.—á.
- `transaction_type` - —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏:
  - `credit` - –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
  - `debit` - —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –∑–∞–Ω—è—Ç–∏–µ
  - `transfer_in` - –ø–µ—Ä–µ–≤–æ–¥ –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞
  - `refund` - –≤–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤
- `description` - –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `lesson_session_id` - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –∑–∞–Ω—è—Ç–∏—é (–µ—Å–ª–∏ —Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ —É—Ä–æ–∫)

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞

–ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è (`status = 'completed'`) —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã:

**–î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π** (`handle_group_lesson_charge`):
```sql
-- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–∞ –≥—Ä—É–ø–ø—ã —Å–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å:
INSERT INTO balance_transactions (
  student_id,
  amount,  -- –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞
  transaction_type,  -- 'debit'
  description,
  lesson_session_id
)
```

**–î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –∑–∞–Ω—è—Ç–∏–π** (`handle_individual_lesson_charge`):
```sql
-- –°–æ–∑–¥–∞–µ—Ç—Å—è –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞:
INSERT INTO balance_transactions (
  student_id,
  amount,  -- –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Å—É–º–º–∞
  transaction_type,  -- 'debit'
  description,
  lesson_session_id
)
```

---

## 3. –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º

### –¢–∞–±–ª–∏—Ü–∞: `teacher_earnings`

–•—Ä–∞–Ω–∏—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º –∑–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è.

**–ü–æ–ª—è:**
- `teacher_id` - UUID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
- `lesson_session_id` - ID –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- `individual_lesson_session_id` - ID –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- `earning_date` - –¥–∞—Ç–∞ –∑–∞–Ω—è—Ç–∏—è
- `academic_hours` - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∞.—á.
- `rate_per_hour` - —Å—Ç–∞–≤–∫–∞ –∑–∞ –∞.—á. –Ω–∞ –º–æ–º–µ–Ω—Ç –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è
- `amount` - —Å—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è (academic_hours √ó rate_per_hour)
- `currency` - –≤–∞–ª—é—Ç–∞ (RUB)
- `status` - —Å—Ç–∞—Ç—É—Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è:
  - `accrued` - –Ω–∞—á–∏—Å–ª–µ–Ω–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
  - `paid` - –æ–ø–ª–∞—á–µ–Ω–æ
  - `cancelled` - –æ—Ç–º–µ–Ω–µ–Ω–æ
- `payment_id` - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –≤—ã–ø–ª–∞—Ç–µ (–∫–æ–≥–¥–∞ status = 'paid')

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π

#### –§—É–Ω–∫—Ü–∏—è: `accrue_teacher_earning_for_lesson()`

–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º–∏ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏—è.

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–Ω—è—Ç–∏–∏:**
   - –î–ª—è –≥—Ä—É–ø–ø–æ–≤—ã—Ö: –±–µ—Ä–µ—Ç `teacher_id` –∏–∑ `learning_groups`, —Å—á–∏—Ç–∞–µ—Ç –∞.—á. –∫–∞–∫ `(end_time - start_time) / 45`
   - –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö: –±–µ—Ä–µ—Ç `teacher_id` –∏–∑ `individual_lessons`, —Å—á–∏—Ç–∞–µ—Ç –∞.—á. –∫–∞–∫ `duration / 40`

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ —Å–æ–∑–¥–∞–Ω–æ –ª–∏ —É–∂–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–≥–æ –∑–∞–Ω—è—Ç–∏—è
   - –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ ID

3. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏:**
   - –í—ã–∑—ã–≤–∞–µ—Ç `get_teacher_rate(teacher_id, branch, subject, lesson_date)`
   - –°—Ç–∞–≤–∫–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ (—Å–º. —Ä–∞–∑–¥–µ–ª "–°—Ç–∞–≤–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π")

4. **–†–∞—Å—á–µ—Ç —Å—É–º–º—ã:**
   ```sql
   amount = rate_per_hour √ó academic_hours
   ```

5. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏:**
   ```sql
   INSERT INTO teacher_earnings (
     teacher_id,
     lesson_session_id,
     individual_lesson_session_id,
     earning_date,
     academic_hours,
     rate_per_hour,
     amount,
     status,
     currency
   ) VALUES (...)
   ```

#### –¢—Ä–∏–≥–≥–µ—Ä—ã

**–¢—Ä–∏–≥–≥–µ—Ä: `trigger_group_lesson_charge`**
```sql
-- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç AFTER UPDATE –Ω–∞ lesson_sessions
-- –£—Å–ª–æ–≤–∏–µ: NEW.status = 'completed' AND OLD.status != 'completed'
-- –î–µ–π—Å—Ç–≤–∏—è:
--   1. –í—ã–∑—ã–≤–∞–µ—Ç accrue_teacher_earning_for_lesson(lesson_session_id, NULL)
--   2. –°–æ–∑–¥–∞–µ—Ç balance_transactions –¥–ª—è –≤—Å–µ—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≥—Ä—É–ø–ø—ã
```

**–¢—Ä–∏–≥–≥–µ—Ä: `trigger_individual_lesson_charge`**
```sql
-- –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç AFTER UPDATE –Ω–∞ individual_lesson_sessions
-- –£—Å–ª–æ–≤–∏–µ: NEW.status = 'completed' AND OLD.status != 'completed'
-- –î–µ–π—Å—Ç–≤–∏—è:
--   1. –í—ã–∑—ã–≤–∞–µ—Ç accrue_teacher_earning_for_lesson(NULL, individual_lesson_session_id)
--   2. –°–æ–∑–¥–∞–µ—Ç balance_transaction –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
```

### –û—Ç–º–µ—Ç–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö

**–§—É–Ω–∫—Ü–∏—è –≤ UI:** `useMarkAccrualsPaid()`

```typescript
// –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ 'paid'
UPDATE teacher_earnings
SET status = 'paid'
WHERE id IN (accrualIds)
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
1. –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å/–±—É—Ö–≥–∞–ª—Ç–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥
2. –û—Ç–º–µ—á–∞–µ—Ç –∏—Ö –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ
3. –ù–∞—á–∏—Å–ª–µ–Ω–∏—è —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å `payment_id` (–≤—ã–ø–ª–∞—Ç–æ–π)

---

## 4. –°—Ç–∞–≤–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π

### –¢–∞–±–ª–∏—Ü–∞: `teacher_rates`

–•—Ä–∞–Ω–∏—Ç —Å—Ç–∞–≤–∫–∏ –æ–ø–ª–∞—Ç—ã —Ç—Ä—É–¥–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π.

**–ü–æ–ª—è:**
- `teacher_id` - UUID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
- `rate_type` - —Ç–∏–ø —Å—Ç–∞–≤–∫–∏:
  - `global` - –≥–ª–æ–±–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (–¥–ª—è –≤—Å–µ—Ö –∑–∞–Ω—è—Ç–∏–π)
  - `branch` - —Å—Ç–∞–≤–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ñ–∏–ª–∏–∞–ª–∞
  - `subject` - —Å—Ç–∞–≤–∫–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞
  - `personal` - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞ (–Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
- `rate_per_academic_hour` - —Å—Ç–∞–≤–∫–∞ –∑–∞ 1 –∞.—á. –≤ —Ä—É–±–ª—è—Ö
- `branch` - —Ñ–∏–ª–∏–∞–ª (–¥–ª—è rate_type = 'branch')
- `subject` - –ø—Ä–µ–¥–º–µ—Ç (–¥–ª—è rate_type = 'subject')
- `valid_from` - –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏—è —Å—Ç–∞–≤–∫–∏
- `valid_until` - –¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è (NULL = –±–µ—Å—Å—Ä–æ—á–Ω–æ)
- `is_active` - –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ —Å—Ç–∞–≤–∫–∞
- `currency` - –≤–∞–ª—é—Ç–∞ (RUB)

### –§—É–Ω–∫—Ü–∏—è: `get_teacher_rate()`

–í—ã–±–∏—Ä–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é —Å—Ç–∞–≤–∫—É –¥–ª—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç–∞–≤–æ–∫** (–æ—Ç –≤—ã—Å—à–µ–≥–æ –∫ –Ω–∏–∑—à–µ–º—É):
1. **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è** (`personal`)
2. **–ü–æ –ø—Ä–µ–¥–º–µ—Ç—É** (`subject`) - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø—Ä–µ–¥–º–µ—Ç
3. **–ü–æ —Ñ–∏–ª–∏–∞–ª—É** (`branch`) - –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω —Ñ–∏–ª–∏–∞–ª
4. **–ì–ª–æ–±–∞–ª—å–Ω–∞—è** (`global`)

**–£—Å–ª–æ–≤–∏—è:**
- `is_active = true`
- `valid_from <= –¥–∞—Ç–∞ –∑–∞–Ω—è—Ç–∏—è`
- `valid_until IS NULL OR valid_until >= –¥–∞—Ç–∞ –∑–∞–Ω—è—Ç–∏—è`
- –í—ã–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ `valid_from DESC`

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç:
// 1. global: 500 ‚ÇΩ/–∞.—á.
// 2. branch='–ö–æ—Ç–µ–ª—å–Ω–∏–∫–∏': 600 ‚ÇΩ/–∞.—á.
// 3. subject='–ê–Ω–≥–ª–∏–π—Å–∫–∏–π': 700 ‚ÇΩ/–∞.—á.
// 4. personal: 800 ‚ÇΩ/–∞.—á.

// –î–ª—è –∑–∞–Ω—è—Ç–∏—è:
// - –§–∏–ª–∏–∞–ª: –ö–æ—Ç–µ–ª—å–Ω–∏–∫–∏
// - –ü—Ä–µ–¥–º–µ—Ç: –ê–Ω–≥–ª–∏–π—Å–∫–∏–π
// –ë—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω–∞ —Å—Ç–∞–≤–∫–∞: 800 ‚ÇΩ/–∞.—á. (personal - –Ω–∞–∏–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∞–º–∏ –≤ UI

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `TeacherRatesModal`

**–§—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Å—Ç–∞–≤–æ–∫ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
- –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏
- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞–≤–∫–∏
- –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏ (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è—Ö)

**–•—É–∫:** `useUpsertTeacherRate()`
```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ç–∞–≤–∫–∏
INSERT INTO teacher_rates (...)

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π
UPDATE teacher_rates
SET ...
WHERE id = rateId
```

---

## 5. –í—ã–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º

### –¢–∞–±–ª–∏—Ü–∞: `teacher_payments`

–•—Ä–∞–Ω–∏—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–ø–ª–∞—Ç—ã –∑–∞—Ä–ø–ª–∞—Ç—ã –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º.

**–ü–æ–ª—è:**
- `teacher_id` - UUID –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
- `amount` - —Å—É–º–º–∞ –≤—ã–ø–ª–∞—Ç—ã
- `payment_date` - –¥–∞—Ç–∞ –≤—ã–ø–ª–∞—Ç—ã
- `payment_method` - —Å–ø–æ—Å–æ–± –≤—ã–ø–ª–∞—Ç—ã (cash, card, transfer)
- `period_start` / `period_end` - –ø–µ—Ä–∏–æ–¥, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤—ã–ø–ª–∞—Ç–∞
- `notes` - –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

### –°–≤—è–∑—å —Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è–º–∏

–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–ø–ª–∞—Ç—ã:
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ `teacher_payments`
2. –í—Å–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∑–∞ –ø–µ—Ä–∏–æ–¥ —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å `payment_id`
3. –°—Ç–∞—Ç—É—Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `'paid'`

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã–ø–ª–∞—Ç—ã
INSERT INTO teacher_payments (...) RETURNING id;

-- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
UPDATE teacher_earnings
SET status = 'paid', payment_id = new_payment_id
WHERE teacher_id = ? 
  AND earning_date BETWEEN period_start AND period_end
  AND status = 'accrued';
```

---

## 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –°—Ç—Ä–∞–Ω–∏—Ü–∞: `/payment-test`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:** `PaymentSystemTest`

–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

**–ü—Ä–æ–≤–µ—Ä—è–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
1. ‚úÖ **–ü–ª–∞—Ç–µ–∂–∏** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–ª–∞—Ç–µ–∂–µ–π —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
2. ‚úÖ **–ù–∞—á–∏—Å–ª–µ–Ω–∏—è** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º
3. ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏–∑–º–µ–Ω–µ–Ω–∏–π –±–∞–ª–∞–Ω—Å–∞
4. ‚úÖ **–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è** - –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–Ω—è—Ç–∏–π —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º 'completed'
5. ‚úÖ **–°—Ç–∞–≤–∫–∏** - –∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ç–∞–≤–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π

**–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:**
- üü¢ **–ó–µ–ª–µ–Ω–∞—è –≥–∞–ª–æ—á–∫–∞** - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç (–µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ)
- üü† **–û—Ä–∞–Ω–∂–µ–≤—ã–µ —á–∞—Å—ã** - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–æ—Ä–º–∞ –¥–ª—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã)

**–ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ"** - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

## 7. API –∏ —Ö—É–∫–∏

### –ü–ª–∞—Ç–µ–∂–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤

```typescript
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
const { mutate: createPayment } = usePayments();
createPayment({
  studentId,
  amount: 6400,
  lessons_count: 8,  // 8 –∞–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏—Ö —á–∞—Å–æ–≤
  method: 'cash',
  payment_date: new Date(),
});

// –£–¥–∞–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º)
const { mutate: deletePayment } = usePayments();
deletePayment(paymentId);
```

### –ù–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º

```typescript
// –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
const { data: accruals } = useTeacherAccruals(
  teacherId,
  '2025-01-01',  // period_start
  '2025-01-31'   // period_end
);

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
const { data: stats } = useTeacherSalaryStats(
  teacherId,
  '2025-01-01',
  '2025-01-31'
);
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: {
//   total_amount: 45000,
//   total_hours: 56.25,
//   total_lessons: 45,
//   group_lessons: 30,
//   individual_lessons: 15,
//   paid_amount: 30000,
//   unpaid_amount: 15000
// }

// –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ
const { mutate: markPaid } = useMarkAccrualsPaid();
markPaid(['accrual_id_1', 'accrual_id_2']);
```

### –°—Ç–∞–≤–∫–∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π

```typescript
// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞–≤–æ–∫
const { data: rates } = useTeacherRates(teacherId);

// –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
const { mutate: upsertRate } = useUpsertTeacherRate();
upsertRate({
  teacher_id: teacherId,
  rate_type: 'branch',
  branch: '–ö–æ—Ç–µ–ª—å–Ω–∏–∫–∏',
  rate_per_academic_hour: 800,
  valid_from: '2025-01-01',
  is_active: true,
});

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞–≤–∫–∏
const { mutate: deleteRate } = useDeleteTeacherRate();
deleteRate(rateId);
```

---

## 8. –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   –°—Ç—É–¥–µ–Ω—Ç   ‚îÇ
‚îÇ   –ø–ª–∞—Ç–∏—Ç    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    payments     ‚îÇ  ‚Üê –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
‚îÇ  lessons_count  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ individual_lesson_       ‚îÇ
‚îÇ    sessions              ‚îÇ  ‚Üê –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ paid_minutes
‚îÇ  paid_minutes += X       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚Üì (–ø—Ä–∏ status = 'completed')
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ
    ‚Üì         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ balance_        ‚îÇ   ‚îÇ teacher_earnings     ‚îÇ
‚îÇ transactions    ‚îÇ   ‚îÇ  (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏      ‚îÇ
‚îÇ (—Å–ø–∏—Å–∞–Ω–∏–µ)      ‚îÇ   ‚îÇ   —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚Üì
                      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                      ‚îÇ teacher_payments     ‚îÇ
                      ‚îÇ (–ø—Ä–∏ –≤—ã–ø–ª–∞—Ç–µ)        ‚îÇ
                      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 9. –í–∞–∂–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞

### –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∏–∑–º–µ–Ω—è–π—Ç–µ `balance_transactions` –≤—Ä—É—á–Ω—É—é** - —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã
2. **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Å—Ç–∞–≤–∫–∏** –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `accrue_teacher_earning_for_lesson()`** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
4. **–¢—Ä–∏–≥–≥–µ—Ä—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ `status = 'completed'`**
5. **–ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª—è—Ç—å `teacher_earnings.status`** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤—ã–ø–ª–∞—Ç—ã

### –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è —Å –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π
2. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ
3. –°–æ–∑–¥–∞–π—Ç–µ –ø–ª–∞—Ç–µ–∂ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞
4. –ó–∞–≤–µ—Ä—à–∏—Ç–µ –∑–∞–Ω—è—Ç–∏–µ (–∏–∑–º–µ–Ω–∏—Ç–µ status –Ω–∞ 'completed')
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ:
   - –°–æ–∑–¥–∞–ª–∞—Å—å `balance_transaction` (debit)
   - –°–æ–∑–¥–∞–ª–æ—Å—å `teacher_earning` (accrued)
   - –°—É–º–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### –î–ª—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏

1. **–ù–∞—á–∏—Å–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–Ω—è—Ç–∏–π
2. **–°—Ç–∞–≤–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∑–∞—Ä–∞–Ω–µ–µ** (–∏–Ω–∞—á–µ —Å—É–º–º–∞ = 0)
3. **–°—Ç–∞—Ç—É—Å 'accrued'** –æ–∑–Ω–∞—á–∞–µ—Ç "–Ω–∞—á–∏—Å–ª–µ–Ω–æ, –Ω–æ –Ω–µ –≤—ã–ø–ª–∞—á–µ–Ω–æ"
4. **–°—Ç–∞—Ç—É—Å 'paid'** –æ–∑–Ω–∞—á–∞–µ—Ç "–≤—ã–ø–ª–∞—á–µ–Ω–æ" (—Å–≤—è–∑–∞–Ω–æ —Å teacher_payment)

---

## 10. –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend (Supabase)
- `supabase/migrations/*_teacher_earnings.sql` - —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π
- `supabase/migrations/*_teacher_rates.sql` - —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞–≤–æ–∫
- `supabase/migrations/*_fix_teacher_earnings_triggers.sql` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã

### Frontend
- `src/hooks/useTeacherSalary.ts` - —Ö—É–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞—Ä–ø–ª–∞—Ç–æ–π
- `src/hooks/usePayments.ts` - —Ö—É–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏
- `src/components/finances/TeacherSalaryManagement.tsx` - UI —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ä–ø–ª–∞—Ç–æ–π
- `src/components/finances/TeacherRatesModal.tsx` - UI —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–≤–∫–∞–º–∏
- `src/components/finances/StudentBalanceCard.tsx` - –∫–∞—Ä—Ç–æ—á–∫–∞ –±–∞–ª–∞–Ω—Å–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞
- `src/pages/PaymentSystemTest.tsx` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

---

## 11. FAQ

**Q: –ü–æ—á–µ–º—É –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏?**

A: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ó–∞–Ω—è—Ç–∏–µ –∏–º–µ–µ—Ç `status = 'completed'`
2. –£ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å—Ç–∞–≤–∫–∞
3. –¢—Ä–∏–≥–≥–µ—Ä—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏)

**Q: –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞–≤–∫—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è?**

A: –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å—Ç–∞–≤–∫—É —Å –Ω–æ–≤–æ–π –¥–∞—Ç–æ–π `valid_from`. –°—Ç–∞—Ä–∞—è —Å—Ç–∞–≤–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–Ω–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–Ω—è—Ç–∏–π.

**Q: –ú–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ?**

A: –î–∞, –Ω–æ –ª—É—á—à–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ `'cancelled'` –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏.

**Q: –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å—Ç–∞–≤–æ–∫?**

A: personal > subject > branch > global. –°–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–µ—Ç —Å–∞–º—É—é —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é —Å—Ç–∞–≤–∫—É.

**Q: –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –Ω–µ—Ç —Å—Ç–∞–≤–∫–∏?**

A: –°–æ–∑–¥–∞–π—Ç–µ —Ö–æ—Ç—è –±—ã –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É (`rate_type = 'global'`). –ò–Ω–∞—á–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –±—É–¥—É—Ç —Å `amount = 0`.

---

**–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 30 –æ–∫—Ç—è–±—Ä—è 2025
